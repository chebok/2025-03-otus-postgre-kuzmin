## –®–∞–≥ 0: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∏–∫–∏
–î–ª—è –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –±—ã–ª –≤—ã–±—Ä–∞–Ω –¥–æ–º–µ–Ω –∫–∞—Ä—à–µ—Ä–∏–Ω–≥–∞

–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ:
- [init.sql](./init.sql)

### –í—ã–±—Ä–∞–Ω–Ω–∞—è –º–µ—Ç–æ–¥–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–∞

–î–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è **—Ç—Ä–∏ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ PostgreSQL:

1. **–¢–∏–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è** (`Hash Join`, `Merge Join`, `Nested Loop`)
2. **–ù–∞–ª–∏—á–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è** (`Seq Scan`)

–≠—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –æ—Ç—Ä–∞–∂–∞—é—Ç –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã:
- —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å—Å—è,
- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è,
- –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –Ω–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö –¥–∞–Ω–Ω—ã—Ö.

### –í–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

–î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–∂–æ–π–Ω–æ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º **–Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤** –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:
- **–° –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º—ã—Ö —É—Å–ª–æ–≤–∏–π**
- **–ë–µ–∑ —É—Å–ª–æ–≤–∏–π**
- **–° –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (`WHERE`)**

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:
- –≤—ã—è–≤–∏—Ç—å –≤–ª–∏—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞,
- –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Nested Loop` ‚Üí `Hash Join`),
- –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å, –∫–∞–∫ PostgreSQL –≤–µ–¥—ë—Ç —Å–µ–±—è –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –∏ —É–º–µ—Ä–µ–Ω–Ω—ã–º–∏ –æ–±—ä—ë–º–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö.

## –®–∞–≥ 1: Join –ø—Ä—è–º–æ–µ —Å–æ–µ–¥–∏–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å. –°–ø–∏—Å–æ–∫ –ø–æ–µ–∑–¥–æ–∫ —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –º–æ–¥–µ–ª—å—é –∞–≤—Ç–æ–º–æ–±–∏–ª—è
```sql
SELECT
   r.id AS ride_id,
   u.name AS user_name,
   c.model AS car_model,
   r.started_at,
   r.ended_at,
   r.distance_km
FROM rides r
JOIN users u ON r.user_id = u.id
JOIN cars c ON r.car_id = c.id;
```
![join1.png](join1.png)
–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:

| –ú–µ—Ç—Ä–∏–∫–∞                                 | –ó–Ω–∞—á–µ–Ω–∏–µ                     | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
|----------------------------------------|------------------------------|--------------------------------------------------|
| –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`JOIN TYPE`)           | `Hash Join √ó2`               | –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–∞–∫–∏—Ö –æ–±—ä—ë–º–æ–≤ –∏ –±–µ–∑ —É—Å–ª–æ–≤–∏–π         |
| –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (`Seq Scan`)   | `rides`, `users`, `cars`     | –û–∂–∏–¥–∞–µ–º–æ: –ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤       |

---

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

- `rides` —á–∏—Ç–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ: `Seq Scan on rides`
- `users` –∏ `cars` –ø–æ–ø–∞–¥–∞—é—Ç –≤ `Hash`, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ `Hash Join`
- `Execution Time`: `~45 ms` –Ω–∞ 100k —Å—Ç—Ä–æ–∫



### –° –≤—ã–±–æ—Ä–∫–æ–π –ø–æ id
```sql
SELECT
   r.id AS ride_id,
   r.started_at,
   r.ended_at,
   r.distance_km,
   u.name AS user_name,
   c.model AS car_model,
   c.status AS car_status
FROM rides r
JOIN users u ON r.user_id = u.id
JOIN cars c ON r.car_id = c.id
WHERE r.id IN (
   101
   );
```

![join2.png](join2.png)

–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:

| –ú–µ—Ç—Ä–∏–∫–∞                                 | –ó–Ω–∞—á–µ–Ω–∏–µ                   | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
|----------------------------------------|----------------------------|--------------------------------------------------|
| –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`JOIN TYPE`)           | `Nested Loop √ó2`           | –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –ø–æ PK    |
| –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (`Seq Scan`)   | ‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç              | –í–µ—Å—å –∑–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º                |

---

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

- `rides` —á–∏—Ç–∞–µ—Ç—Å—è –ø–æ `id = 101` —á–µ—Ä–µ–∑ `Index Scan` (–∏–Ω–¥–µ–∫—Å `idx_rides_id`)
- `users` –∏ `cars` –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –ø–æ –ø–µ—Ä–≤–∏—á–Ω—ã–º –∫–ª—é—á–∞–º —á–µ—Ä–µ–∑ `Index Scan`
- –í—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ `Nested Loop`, —Ç.–∫. –∫–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤—ã–¥–∞—ë—Ç —Ä–æ–≤–Ω–æ –ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
- `Seq Scan` –Ω–∏–≥–¥–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- `Execution Time`: `~0.045 ms` ‚Äî –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

## –®–∞–≥ 2: Left join

### –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π —Å ID –≤—ã—à–µ 100, –≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å—Ç–∞—Ç—É—Å–µ –∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∏–∑–≤–µ—Å—Ç–Ω–æ–π –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ ID
```sql
SELECT
   c.id AS car_id,
   c.model,
   c.status,
   l.updated_at AS last_location_time,
   l.lat,
   l.lon
FROM cars c
LEFT JOIN locations l ON l.car_id = c.id
WHERE c.id > 100
ORDER BY c.id
LIMIT 100;
```
![left.png](left.png)

–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:

| –ú–µ—Ç—Ä–∏–∫–∞                                 | –ó–Ω–∞—á–µ–Ω–∏–µ                        | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                       |
|----------------------------------------|---------------------------------|--------------------------------------------------------------------|
| –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`JOIN TYPE`)           | `Merge Left Join`               | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∑–∞ —Å—á—ë—Ç —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–æ–≥–æ `ORDER BY c.id`, –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã |
| –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (`Seq Scan`)   | ‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç                   | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã `Index Scan` –Ω–∞ –æ–±–µ–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö                       |

---

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

- `cars` —á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `Index Scan` —Å —Ñ–∏–ª—å—Ç—Ä–æ–º: `id > 100`
- `locations` —á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –∏–Ω–¥–µ–∫—Å—É `car_id`: `Index Scan using idx_locations_car_id`
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ `Merge Left Join`, —Ç.–∫. –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ `id`
- `LEFT JOIN` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–≤–µ—Å—Ç–∏ –¥–∞–∂–µ —Ç–µ –º–∞—à–∏–Ω—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö **–Ω–µ—Ç –ª–æ–∫–∞—Ü–∏–π**
- `LIMIT 100` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è
- `Execution Time`: `~0.2 ms` –Ω–∞ 100 —Å—Ç—Ä–æ–∫

## –®–∞–≥ 3: Union ALL

### –ò–º–∏—Ç–∏—Ä—É–µ–º –ª–µ–Ω—Ç—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è —é–∑–µ—Ä–∞

```sql
SELECT
    r.user_id,
    'ride' AS activity_type,
    r.started_at AS occurred_at,
    r.distance_km,
    NULL::numeric AS fine_amount,
    NULL AS event_type
FROM rides r
WHERE r.started_at >= NOW() - INTERVAL '30 days'

UNION ALL

SELECT
    r.user_id,
    'fine' AS activity_type,
    f.issued_at AS occurred_at,
    NULL,
    f.amount,
    NULL
FROM fines f
JOIN rides r ON r.id = f.ride_id
WHERE f.issued_at >= NOW() - INTERVAL '30 days'

UNION ALL

SELECT
    e.user_id,
    'user_event' AS activity_type,
    e.occurred_at,
    NULL,
    NULL,
    e.event_type
FROM user_events e
WHERE e.occurred_at >= NOW() - INTERVAL '30 days'

ORDER BY user_id, occurred_at DESC
LIMIT 100;
```

![union.png](union.png)

–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:

| –ú–µ—Ç—Ä–∏–∫–∞                                | –ó–Ω–∞—á–µ–Ω–∏–µ                                 | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                        |
|----------------------------------------|------------------------------------------|--------------------------------------------------------------------|
| –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`JOIN TYPE`)           | `Hash Join` + `Parallel Append`          | –ü–ª–∞–Ω —Å–ª–∏—è–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤—ã–±–æ—Ä–æ–∫ —á–µ—Ä–µ–∑ `UNION ALL` —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å—é |
| –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (`Seq Scan`)   | `rides`, `fines`, `user_events`          | –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —á–∏—Ç–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ                               |
| –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (`Sort`)                    | `top-N heapsort` –ø–æ `user_id, ts`        | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ `LIMIT`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Incremental Sort`        |

---

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Parallel Append` ‚Äî **–∑–∞–ø—Ä–æ—Å —Ä–∞–∑–±–∏—Ç –Ω–∞ –ø–æ–¥–¥–µ—Ä–µ–≤—å—è**, –∫–æ—Ç–æ—Ä—ã–µ PostgreSQL –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å 2 –≤–æ—Ä–∫–µ—Ä–∞ (`Workers Planned: 2`), –Ω–æ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è 1 (`Workers Launched: 1`) ‚Äî **—ç—Ñ—Ñ–µ–∫—Ç –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞ –ø—Ä–æ—è–≤–∏–ª—Å—è**.
- –ü–æ–¥–∑–∞–ø—Ä–æ—Å —Å `fines` –æ–±—ä–µ–¥–∏–Ω—ë–Ω —Å `rides` —á–µ—Ä–µ–∑ `Hash Join`, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ `Seq Scan`.
- –ì–ª–∞–≤–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ‚Äî `Sort Key: user_id, issued_at DESC` ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∫ `top-N heapsort`, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –∑–∞ —Å—á—ë—Ç `LIMIT 100`.
- `Execution Time`: **~61 ms –ø—Ä–∏ –æ–±—ä—ë–º–µ –¥–∞–Ω–Ω—ã—Ö –≤ 223 000 —Å—Ç—Ä–æ–∫ –¥–æ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏**.


## –®–∞–≥ 4: Lateral join

### –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –ø–æ–µ–∑–¥–æ–∫ —é–∑–µ—Ä–∞

```sql
SELECT
    u.id AS user_id,
    u.name,
    r.id AS ride_id,
    r.started_at,
    r.ended_at,
    r.distance_km
FROM users u
LEFT JOIN LATERAL (
    SELECT *
    FROM rides r
    WHERE r.user_id = u.id
    ORDER BY r.started_at DESC
    LIMIT 5
) r ON true
WHERE u.id BETWEEN 1 AND 10
ORDER BY u.id, r.started_at DESC;
```

![lateral.png](lateral.png)

–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:

| –ú–µ—Ç—Ä–∏–∫–∞                                 | –ó–Ω–∞—á–µ–Ω–∏–µ                     | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                  |
|----------------------------------------|------------------------------|---------------------------------------------------------------|
| –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`JOIN TYPE`)           | `Nested Loop Left Join`      | –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å (`LATERAL`)    |
| –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (`Seq Scan`)   | ‚ùå –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç                | `users` –∏ `rides` —á–∏—Ç–∞—é—Ç—Å—è –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º (`Index Scan` + `Bitmap`) |
| –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞                              | `Incremental Sort`           | PostgreSQL –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª 5 –ø–æ–µ–∑–¥–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∏–∑ 10 —é–∑–µ—Ä–æ–≤     |

---

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

- `Incremental Sort` postgres –ø–æ–Ω—è–ª, —á—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≥—Ä—É–ø–ø—ã —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
- `users` –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Ñ–∏–ª—å—Ç—Ä–æ–º `u.id BETWEEN 1 AND 10`, —á–∏—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `Index Scan` –ø–æ PK
- –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —é–∑–µ—Ä–∞:
    - —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `LATERAL`, –≤—ã—Ç—è–≥–∏–≤–∞—é—â–∏–π `LIMIT 5` –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫
    - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Bitmap Index Scan` –ø–æ `rides.user_id`
    - –∑–∞—Ç–µ–º `Sort` –ø–æ `r.started_at DESC`
- –§–∏–Ω–∞–ª—å–Ω—ã–π `Incremental Sort` –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≥—Ä—É–ø–ø–∞–º (`u.id`)
- –í—Å–µ–≥–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è: **10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π √ó –¥–æ 5 –ø–æ–µ–∑–¥–æ–∫ = 50 —Å—Ç—Ä–æ–∫**
- `Execution Time`: `~1.59 ms` ‚Äî –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ


## –®–∞–≥ 5: –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å c –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CTE

### –ù–∞–π—Ç–∏ –ø–æ–µ–∑–¥–∫–∏/—à—Ç—Ä–∞—Ñ—ã –ø–æ —é–∑–µ—Ä—É —Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º –∏–º–µ–Ω–µ–º

```sql
WITH recent_rides AS (
    SELECT id, user_id
    FROM rides
    WHERE started_at >= NOW() - INTERVAL '7 days'
),
fined_users AS (
    SELECT DISTINCT r.user_id
    FROM rides r
    JOIN fines f ON f.ride_id = r.id
)
SELECT u.name, e.event_type
FROM users u
JOIN recent_rides rr ON rr.user_id = u.id
LEFT JOIN user_events e ON e.user_id = u.id
JOIN fined_users fu ON fu.user_id = u.id
WHERE u.name LIKE 'User_%1'
```

![combined.png](combined.png)

–ú–µ—Ç—Ä–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞:

| –ú–µ—Ç—Ä–∏–∫–∞                               | –ó–Ω–∞—á–µ–Ω–∏–µ                                                   | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                                 |
|---------------------------------------|-------------------------------------------------------------|------------------------------------------------------------------------------|
| –¢–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (`JOIN TYPE`)          | `Nested Loop Left Join`, `Nested Loop`, `Hash Join √ó2`     | –°–ª–æ–∂–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –≤–Ω–µ—à–Ω–∏–π `LEFT JOIN`, –≤–Ω—É—Ç—Ä–∏ –∫–∞—Å–∫–∞–¥–Ω—ã–µ `Hash` –∏ `Nested` |
| –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ (`Seq Scan`)  | `users`, `rides`, `fines`                                   | –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ –ø–æ `users`, `rides`, `fines` ‚Äî —Ç–∏–ø–∏—á–Ω–æ –ø—Ä–∏ –Ω–µ—É–∑–∫–æ–º —Ñ–∏–ª—å—Ç—Ä–µ    |
| –ò–Ω–¥–µ–∫—Å–Ω—ã–µ —á—Ç–µ–Ω–∏—è (`Index Scan`)       | `rides.user_id`, `user_events.user_id`                      | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `user_id`, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã        |
| –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (`Memoize`)               | `ON user_events`                                            | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è `LEFT JOIN`, –∫–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ üíØ         |
| –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`Execution Time`)   | `~34 ms` –Ω–∞ 7k —Å—Ç—Ä–æ–∫                                        | –û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å–ª–æ–∂–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞                                     |

---

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫:

- `users` —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ —à–∞–±–ª–æ–Ω—É `name ~~ 'User_1%'` ‚Üí –æ—Å—Ç–∞—ë—Ç—Å—è ~100 —Å—Ç—Ä–æ–∫.
- –î–ª—è –∫–∞–∂–¥–æ–π –∏–∑ –Ω–∏—Ö —Å—á–∏—Ç–∞–µ—Ç—Å—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ `rides` + `fines` (`Hash Join` –≤–Ω—É—Ç—Ä–∏ `HashAggregate`).
- –î–∞–ª–µ–µ ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–µ–∑–¥–æ–∫ –∑–∞ 7 –¥–Ω–µ–π —á–µ—Ä–µ–∑ `Index Scan` –ø–æ `idx_rides_user_id`.
- –ù–∞ —ç—Ç–∞–ø–µ `LEFT JOIN` –∫ `user_events` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `Memoize` ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —á—Ç–µ–Ω–∏—è –∏–∑ `user_events` –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è.

